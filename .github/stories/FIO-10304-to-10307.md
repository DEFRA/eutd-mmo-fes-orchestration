# FIO-10304 to 10307: Point of Destination Field - Backend API Changes

## Overview
This document outlines the backend API changes required for the orchestration service to support the new "Point of destination" field for Storage Document transport modes: truck, plane, train, and container-vessel.

**Related Tickets**: FIO-10304 (truck), FIO-10305 (plane), FIO-10306 (train), FIO-10307 (container-vessel)

**Frontend Implementation Date**: 19 November 2025

---

## API Endpoint Changes

### Affected Endpoints

All transport detail endpoints for Storage Documents need to accept and validate the new `pointOfDestination` field:

- `POST /api/storage-document/{documentNumber}/transportation/truck`
- `POST /api/storage-document/{documentNumber}/transportation/plane`
- `POST /api/storage-document/{documentNumber}/transportation/train`
- `POST /api/storage-document/{documentNumber}/transportation/containerVessel`
- `PUT /api/storage-document/{documentNumber}/transportation/{transportId}` (for updates)

---

## Request Payload Changes

### Transport Object Schema

Add the following field to the transport object schema:

```json
{
  "pointOfDestination": "string | null"
}
```

**Field Position**: This field should appear after `exportedTo` (consignment destination) in the transport object.

### Example Request Payload (Truck)

```json
{
  "exportedTo": "FR",
  "pointOfDestination": "Calais port",
  "departurePlace": "Dover port",
  "nationalityOfVehicle": "GB",
  "registrationNumber": "BD51SMR",
  "departureCountry": "GB",
  "departurePort": "Dover",
  "departureDate": "2025-02-15",
  "freightBillNumber": "FRE123456",
  "containerNumbers": ["ABCD1234567"]
}
```

### Example Request Payload (Plane)

```json
{
  "exportedTo": "FR",
  "pointOfDestination": "Calais-Dunkerque airport",
  "departurePlace": "London Heathrow",
  "flightNumber": "BA123",
  "departureCountry": "GB",
  "departurePort": "LHR",
  "departureDate": "2025-02-15",
  "freightBillNumber": "FRE123456",
  "airwayBillNumber": "AWB789",
  "containerNumbers": ["CONT123"]
}
```

### Example Request Payload (Train)

```json
{
  "exportedTo": "FR",
  "pointOfDestination": "Paris Gare du Nord",
  "departurePlace": "London St Pancras",
  "railwayBillNumber": "RB123456",
  "departureCountry": "GB",
  "departurePort": "St Pancras",
  "departureDate": "2025-02-15",
  "placeOfUnloading": "Paris",
  "freightBillNumber": "FRE123456",
  "containerNumbers": ["CONT456"]
}
```

### Example Request Payload (Container-Vessel)

```json
{
  "exportedTo": "FR",
  "pointOfDestination": "Port of Le Havre",
  "departurePlace": "Southampton",
  "vesselName": "HMS Victory",
  "flagState": "GB",
  "departureCountry": "GB",
  "departurePort": "Southampton",
  "departureDate": "2025-02-15",
  "freightBillNumber": "FRE123456",
  "containerNumbers": ["VESS789"]
}
```

---

## Validation Rules

### Field: `pointOfDestination`

| Rule | Value | Error Key | HTTP Status |
|------|-------|-----------|-------------|
| **Required** | Yes (when saving and continuing) | `error.pointOfDestination.any.required` | 400 |
| **Optional** | When saving as draft | N/A | N/A |
| **Data Type** | String | N/A | N/A |
| **Max Length** | 100 characters | `error.pointOfDestination.string.max` | 400 |
| **Allowed Characters** | Letters (a-z, A-Z), numbers (0-9), hyphen (-), apostrophe ('), space ( ), forward slash (/) | `error.pointOfDestination.string.pattern.base` | 400 |
| **Regex Pattern** | `/^[a-zA-Z0-9\\-' /]+$/` | N/A | N/A |

### Validation Behavior

#### Save and Continue
- `pointOfDestination` is **required**
- Must pass all validation rules (max length, allowed characters)
- Return validation errors if any rule fails

#### Save as Draft
- `pointOfDestination` is **optional**
- If provided but invalid (max length or regex fails), **strip the value** (save as null/undefined)
- Do NOT return validation errors
- Allow saving with missing or stripped `pointOfDestination`

---

## Response Changes

### Success Response (200/201)

No changes to the success response structure. The saved transport object should include the `pointOfDestination` field:

```json
{
  "id": "transport123",
  "documentNumber": "GBR-2022-SD-3FE1169D1",
  "transportMode": "truck",
  "exportedTo": "FR",
  "pointOfDestination": "Calais port",
  "departurePlace": "Dover port",
  "nationalityOfVehicle": "GB",
  "registrationNumber": "BD51SMR",
  ...
}
```

### Validation Error Response (400)

When `pointOfDestination` fails validation (save and continue only):

```json
{
  "pointOfDestination": "error.pointOfDestination.any.required"
}
```

```json
{
  "pointOfDestination": "error.pointOfDestination.string.max"
}
```

```json
{
  "pointOfDestination": "error.pointOfDestination.string.pattern.base"
}
```

**Note**: The frontend maps these error keys to user-friendly messages:
- `error.pointOfDestination.any.required` → "Enter the point of destination" (EN) / "Rhowch y gyrchfan" (CY)
- `error.pointOfDestination.string.max` → "Point of destination must not exceed 100 characters" (EN) / "Rhaid i'r gyrchfan fod yn llai na 100 o nodau" (CY)
- `error.pointOfDestination.string.pattern.base` → "Point of destination must only contain letters, numbers, hyphens, apostrophes, spaces and forward slashes" (EN) / "Rhaid i'r gyrchfan gynnwys llythrennau, rhifau, cysylltnodau, collnodau, bylchau a blaenslaesau yn unig" (CY)

---

## Database Changes

### Storage

Add a new column to the transport details table:

| Column Name | Data Type | Nullable | Max Length | Default |
|-------------|-----------|----------|------------|---------|
| `point_of_destination` | VARCHAR | YES | 100 | NULL |

### Index Considerations

No specific index required for this field as it's a free-text field used for display purposes only.

---

## Testing Scenarios

The backend team should implement tests for the following scenarios:

### Valid Data
1. ✅ Save with valid `pointOfDestination` (50 chars, mixed letters/numbers/allowed symbols)
2. ✅ Save with valid `pointOfDestination` (100 chars exactly - boundary test)
3. ✅ Save with valid `pointOfDestination` containing hyphens, apostrophes, spaces, forward slashes
4. ✅ Save as draft with missing `pointOfDestination` (should save successfully)
5. ✅ Update existing transport with new `pointOfDestination`

### Invalid Data (Save and Continue)
1. ❌ Empty `pointOfDestination` → Return `error.pointOfDestination.any.required`
2. ❌ `pointOfDestination` with 101 characters → Return `error.pointOfDestination.string.max`
3. ❌ `pointOfDestination` with special characters (@, #, $, %, &, etc.) → Return `error.pointOfDestination.string.pattern.base`

### Save as Draft (Invalid Data Should Be Stripped)
1. ✅ Save as draft with 101-character `pointOfDestination` → Save with `pointOfDestination` = null
2. ✅ Save as draft with special characters → Save with `pointOfDestination` = null
3. ✅ Save as draft with valid `pointOfDestination` → Save with provided value

---

## Migration Notes

### Existing Data
- Existing transport records will have `pointOfDestination` = null
- No data migration required
- Frontend will display empty field for existing records

### Backward Compatibility
- This is a **non-breaking change** - adding a new optional field
- Old frontend versions without this field will continue to work (they won't send `pointOfDestination`)
- New frontend requires backend support to accept and validate the field

### Deployment Order
1. **Backend first**: Deploy orchestration service changes to accept `pointOfDestination`
2. **Frontend second**: Deploy frontend with new field once backend is live
3. **Rollback**: If frontend needs to be rolled back, backend will continue to accept/store the field (no issues)

---

## API Contract Version

Update API version to reflect this change:
- **Current Version**: v1.x
- **New Version**: v1.x+1 (minor version bump - backward compatible addition)

---

## Error Key Reference

For consistency with existing error messages, the backend should use these exact error keys:

| Error Scenario | Error Key | HTTP Status |
|----------------|-----------|-------------|
| Missing value | `error.pointOfDestination.any.required` | 400 |
| Exceeds 100 chars | `error.pointOfDestination.string.max` | 400 |
| Invalid characters | `error.pointOfDestination.string.pattern.base` | 400 |

---

## Examples for QA Testing

### Test 1: Valid Point of Destination
**Request**:
```bash
POST /api/storage-document/GBR-2022-SD-123/transportation/truck
Content-Type: application/json

{
  "exportedTo": "FR",
  "pointOfDestination": "Calais port",
  "departurePlace": "Dover port",
  "nationalityOfVehicle": "GB",
  "registrationNumber": "BD51SMR"
}
```

**Expected Response**: 200/201 with saved transport object including `pointOfDestination`

---

### Test 2: Empty Point of Destination (Save and Continue)
**Request**:
```bash
POST /api/storage-document/GBR-2022-SD-123/transportation/truck
Content-Type: application/json

{
  "exportedTo": "FR",
  "pointOfDestination": "",
  "departurePlace": "Dover port",
  "nationalityOfVehicle": "GB",
  "registrationNumber": "BD51SMR"
}
```

**Expected Response**: 400 Bad Request
```json
{
  "pointOfDestination": "error.pointOfDestination.any.required"
}
```

---

### Test 3: Max Length Exceeded
**Request**:
```bash
POST /api/storage-document/GBR-2022-SD-123/transportation/truck
Content-Type: application/json

{
  "exportedTo": "FR",
  "pointOfDestination": "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
  "departurePlace": "Dover port",
  "nationalityOfVehicle": "GB",
  "registrationNumber": "BD51SMR"
}
```

**Expected Response**: 400 Bad Request
```json
{
  "pointOfDestination": "error.pointOfDestination.string.max"
}
```

---

### Test 4: Invalid Characters
**Request**:
```bash
POST /api/storage-document/GBR-2022-SD-123/transportation/truck
Content-Type: application/json

{
  "exportedTo": "FR",
  "pointOfDestination": "Calais@port#123",
  "departurePlace": "Dover port",
  "nationalityOfVehicle": "GB",
  "registrationNumber": "BD51SMR"
}
```

**Expected Response**: 400 Bad Request
```json
{
  "pointOfDestination": "error.pointOfDestination.string.pattern.base"
}
```

---

### Test 5: Save as Draft with Invalid Data
**Request**:
```bash
POST /api/storage-document/GBR-2022-SD-123/transportation/truck?draft=true
Content-Type: application/json

{
  "exportedTo": "FR",
  "pointOfDestination": "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa",
  "departurePlace": "Dover port",
  "nationalityOfVehicle": "GB",
  "registrationNumber": "BD51SMR"
}
```

**Expected Response**: 200/201 with saved transport object where `pointOfDestination` = null (stripped)

---

## Support Contact

For questions or clarifications, contact:
- **Frontend Team**: [Team Contact]
- **Product Owner**: [PO Contact]
- **QA Lead**: [QA Contact]

---

## Change Log

| Date | Version | Author | Changes |
|------|---------|--------|---------|
| 19 November 2025 | 1.0 | Frontend Team | Initial documentation for FIO-10304-10307 |
