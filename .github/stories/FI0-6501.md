# FI0-6501 — Spec: Upgrade Jest (and handle mongodb-memory-server on arm64)

## Summary

Upgrade the repository's `jest` version and related test tooling. While doing this, address failing tests caused by `mongodb-memory-server@3.1.3` which does not support arm64 and throws "unsupported architecture" locally on Apple Silicon. The spec documents short-term workarounds, a migration approach for `mongodb-memory-server`, CI considerations, risks, and acceptance criteria.

## Background / Problem

- Tests in `export-payload.service.spec.ts` (and others calling `getLandingsRefreshData`) started failing after updating `jest`.
- Local investigation shows `mongodb-memory-server@3.1.3` throws: "unsupported architecture, ia32 and x64 are the only valid options" on arm64 machines.
- Historically a local workaround was to set `MONGOMS_ARCH=arm64` in environment, but this is fragile and `mongodb-memory-server@3.x` is unmaintained and limited to x64/ia32.

## Goals

- Upgrade `jest` to a supported, maintained version used by the project.
- Ensure tests run reliably on developer machines (including arm64) and in CI.
- Replace or upgrade `mongodb-memory-server` to a maintained version, migrating code where needed.
- Minimise disruption: provide a short-term workaround so developers aren't blocked while full migration occurs.

## Scope

In scope:

- Bumping `jest` (and related packages such as `ts-jest`, `jest-environment-node`/`jest-environment-jsdom` if present).
- Investigating and upgrading `mongodb-memory-server` to a supported major and migrating tests to new APIs.
- Updating test setup files, possibly mocks or helpers that instantiate in-memory MongoDB.
- Updating CI settings as needed (runner architecture or alternative test DB).

Out of scope:

- Rewriting tests not directly affected by the upgrades beyond necessary fixes.

## Short-term Workarounds (temporary)

1. Local env variable: keep using `MONGOMS_ARCH=arm64` in developer `.env.test` or test run scripts to force the binary selection (works only if the installed `mongodb-memory-server` version supports this env override). Document this in README.
2. Use an external MongoDB for local tests: add a `.env.test` pointing `MONGO_URL` to a running local/remote Mongo instance to bypass `mongodb-memory-server`.
3. Pin CI to x64 runners (if tests must run in CI and CI has x64) while migration occurs.

These are temporary and should be documented as non-ideal.

## Migration / Upgrade Plan

1. Reproduce
   - Run the test suite locally on an arm64 machine and capture failing tests and stack traces (done by reporter).

2. Short-term unblock
   - Add documentation and optionally update `test` npm script in `package.json` to use `cross-env MONGOMS_ARCH=arm64 jest` for local dev on arm64.

3. Upgrade evaluation
   - Review changelog for `mongodb-memory-server` between current `3.1.3` and latest maintained major (v6+ at time of writing).
   - Note breaking changes: newer majors change instantiation APIs (e.g., `await MongoMemoryServer.create()`), binary download behavior, and possibly require Node.js version adjustments.

4. Implement upgrade in a feature branch
   - Bump `mongodb-memory-server` to a maintained major (choose the latest stable tested version). Also bump `jest` and `ts-jest` (if used) at the same time to compatible versions.
   - Update test setup code to use the new API (e.g., `const mongod = await MongoMemoryServer.create(); const uri = mongod.getUri();`).
   - Replace imports if the package split changed (some newer versions use `mongodb-memory-server-core` or different entry points).

5. Run and fix tests locally
   - Fix flakey tests, update timeouts if necessary, and address any Jest API changes (e.g., `done` handling, jest lifecycle hooks, or changes to fake timers).

6. CI adjustments
   - Ensure CI runner architecture is compatible with in-memory server binary downloads. Options:
     - Use x64 runners (recommended short-term if CI supports it).
     - Use a prebuilt binary cache for the mongodb-memory-server downloads in CI.
     - Configure CI to run tests against a hosted MongoDB instance (e.g., ephemeral container) rather than in-memory server.

7. Finalize
   - Remove temporary `MONGOMS_ARCH` hacks and `.env` changes once the upgrade is stable.
   - Update README/test docs with how to run tests on arm64.

## Code Changes to Expect

- Test bootstrapping files (common test setup) where `MongoMemoryServer` is instantiated will need updating to the new create API.
- Any code depending on internal behaviors of the in-memory server may require small updates.
- `jest` config in `package.json` or `jest.config.js` may require minor tweaks (e.g., `testEnvironment`, `testTimeout`, or transformer settings for TypeScript).

## Risks and Mitigations

- Risk: Upgrading `mongodb-memory-server` causes many test failures due to API changes or timing differences.
  - Mitigation: Run incremental changes in a feature branch, keep short-lived CI matrix with x64, and fix tests iteratively.
- Risk: `jest` major upgrade introduces incompatible behavior (fake timers, changed defaults).
  - Mitigation: Read Jest migration guide, pin intermediate versions if necessary, run the full suite and address deprecations.

## Rollback Plan

- If tests in main/CI break irreparably, revert the dependency bump commit(s) and restore previous `package.json`/`package-lock.json`/`yarn.lock` and `jest` config.

## Testing & Acceptance Criteria

- All unit tests pass locally on both x64 and arm64 developer machines.
- CI runs pass with the chosen CI configuration (x64 or alternative) after the upgrade.
- No test is skipped silently — any tests temporarily skipped must be tracked and fixed within a short timeframe.

## Timeline & Effort Estimate

- Investigation & spec: 1 day (complete).
- Short-term workaround and docs: 0.5 day.
- Upgrade and fixes: 1–3 days depending on number of failing tests and API migration complexity.

## Owners

- Primary: @Isaac Babalola
- Reviewers: Core backend team

## Next Steps

1. Confirm priority and whether to proceed with immediate upgrade or apply short-term workarounds.
2. If proceeding, create a feature branch and start by bumping dev dependencies and migrating one test setup file to validate the new `mongodb-memory-server` API.

---

Notes: This spec focuses on upgrading `jest` but prioritises resolving `mongodb-memory-server` compatibility because it is the immediate cause of arm64 failures. The upgrade of Jest itself is straightforward compared to the in-memory Mongo migration, which is likely the larger effort.
